{% extends "base.html" %}

{% block head %}
{{ super() }}
<style>
  .settings-section { margin-bottom: 25px; }
  .add-form { display: flex; gap: 10px; margin-bottom: 20px; }
  .add-form input { flex-grow: 1; margin-bottom: 0; }
  .item-list { list-style: none; padding: 0; }
  .item-list li { display: flex; justify-content: space-between; align-items: center; padding: 10px 5px; border-bottom: 1px solid #eee; }
  .item-actions { display: flex; gap: 10px; }
  .edit-form { display: none; gap: 10px; width: 100%; }
</style>
{% endblock %}

{% block content %}
<h1>הגדרות מערכת</h1>

<div class="card settings-section">

<div class="card settings-section">
    <h2>הגדרות פרופיל</h2>
    <p>כאן תוכל לעדכן את הגדרות המשתמש שלך, כמו אזור זמן.</p>
    <a href="{{ url_for('profile_settings') }}" class="btn btn-primary">עבור להגדרות פרופיל</a>
</div>

<div class="card settings-section">
    <h2>ניהול סוגי רישום</h2>
    <form action="{{ url_for('add_contact_type') }}" method="post" class="add-form">
        <input type="text" name="name" placeholder="הוסף סוג חדש (למשל: ליד, לקוח)" required>
        <button type="submit" class="btn btn-primary">הוסף</button>
    </form>
    <ul class="item-list">
        {% for c_type in contact_types %}
        <li>
            <span class="item-name">{{ c_type.name }}</span>
            <form class="edit-form" action="{{ url_for('edit_setting', item_type='contact_type', item_id=c_type.id) }}" method="post">
                <input type="text" name="name" value="{{ c_type.name }}" required>
                <button type="submit" class="btn btn-success">שמור</button>
            </form>
            <div class="item-actions">
                <button type="button" class="edit-btn">ערוך</button>
                <form action="{{ url_for('delete_setting', item_type='contact_type', item_id=c_type.id) }}" method="post" onsubmit="return confirm('האם אתה בטוח?');">
                    <button type="submit" class="btn btn-danger">מחק</button>
                </form>
            </div>
        </li>
        {% endfor %}
    </ul>
</div>

{% for c_type in contact_types %}
<div class="card settings-section">
    <h3>ניהול סטטוסים עבור: {{ c_type.name }}</h3>
    <form action="{{ url_for('add_status') }}" method="post" class="add-form">
        <input type="hidden" name="contact_type_id" value="{{ c_type.id }}">
        <input type="text" name="name" placeholder="הוסף סטטוס חדש" required>
        <button type="submit" class="btn btn-primary">הוסף</button>
    </form>
    <ul class="item-list">
        {% for status in c_type.statuses %}
        <li>
            <span class="item-name">{{ status.name }}</span>
            <form class="edit-form" action="{{ url_for('edit_setting', item_type='status', item_id=status.id) }}" method="post">
                <input type="text" name="name" value="{{ status.name }}" required>
                <button type="submit" class="btn btn-success">שמור</button>
            </form>
            <div class="item-actions">
                <button type="button" class="edit-btn">ערוך</button>
                <form action="{{ url_for('delete_setting', item_type='status', item_id=status.id) }}" method="post" onsubmit="return confirm('האם אתה בטוח?')">
                    <button type="submit" class="btn btn-danger">מחק</button>
                </form>
            </div>
        </li>
        {% endfor %}
    </ul>
</div>
{% endfor %}

<div class="card settings-section">
    <h2>ניהול סוגי התקשרות</h2>
    <form action="{{ url_for('add_activity_type') }}" method="post" class="add-form">
        <input type="text" name="name" placeholder="הוסף סוג חדש (למשל: שיחת טלפון)" required>
        <button type="submit" class="btn btn-primary">הוסף</button>
    </form>
    <ul class="item-list">
        {% for a_type in activity_types %}
        <li>
            <span class="item-name">{{ a_type.name }}</span>
            <form class="edit-form" action="{{ url_for('edit_setting', item_type='activity_type', item_id=a_type.id) }}" method="post">
                <input type="text" name="name" value="{{ a_type.name }}" required>
                <button type="submit" class="btn btn-success">שמור</button>
            </form>
            <div class="item-actions">
                <button type="button" class="edit-btn">ערוך</button>
                <form action="{{ url_for('delete_setting', item_type='activity_type', item_id=a_type.id) }}" method="post" onsubmit="return confirm('האם אתה בטוח?')">
                    <button type="submit" class="btn btn-danger">מחק</button>
                </form>
            </div>
        </li>
        {% endfor %}
    </ul>
</div>
<div class="card settings-section">
    <h2>ניהול כללי</h2>
    <a href="{{ url_for('manage_users') }}" class="btn btn-primary">ניהול משתמשים והרשאות</a>
</div>
<div class="card settings-section">
    <h2>אינטגרציות</h2>
    {% if current_user.gmail_credentials_json %}
        <p style="color: green;"><strong>חשבון Gmail מחובר.</strong></p>
    {% else %}
        <p>חבר את חשבון ה-Gmail שלך כדי לשלוח ולסנכרן מיילים.</p>
        <a href="{{ url_for('authorize_gmail') }}" class="btn btn-primary">חבר חשבון Gmail</a>
    {% endif %}
</div>

<div class="card settings-section">
    <h2>ניהול שדות מותאמים אישית</h2>
    <form action="{{ url_for('add_custom_field') }}" method="post" class="add-form">
        <input type="text" name="name" placeholder="הוסף שדה חדש (למשל: טלפון נוסף)" required>
        <button type="submit" class="btn btn-primary">הוסף שדה</button>
    </form>
    <ul class="item-list">
        {% for field in custom_fields %}
        <li>
            <span class="item-name">{{ field.name }}</span>
            {# --- שורה חדשה להצגת המזהה --- #}
            <small style="color: #6c757d; display: block;">API ID: <code>{{ field.api_identifier }}</code></small>
        </div>
            <form class="edit-form" action="{{ url_for('edit_custom_field', field_id=field.id) }}" method="post">
                <input type="text" name="name" value="{{ field.name }}" required>
                <button type="submit" class="btn btn-success">שמור</button>
            </form>
            <div class="item-actions">
                <button type="button" class="edit-btn">ערוך</button>
                <form action="{{ url_for('delete_custom_field', field_id=field.id) }}" method="post" onsubmit="return confirm('האם אתה בטוח?');">
                    <button type="submit" class="btn btn-danger">מחק</button>
                </form>
            </div>
        </li>
        {% endfor %}
    </ul>
</div>

<script>
document.querySelectorAll('.edit-btn').forEach(button => {
    button.addEventListener('click', event => {
        const li = event.target.closest('li');
        li.querySelector('.item-name').style.display = 'none';
        li.querySelector('.item-actions').style.display = 'none';
        li.querySelector('.edit-form').style.display = 'flex';
    });
});
</script>
{% endblock %}
{% extends "base.html" %}

{% block head %}
{{ super() }}
<style>
  .settings-section {
    background-color: var(--panel-bg-color);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    padding: 25px;
    margin-bottom: 25px;
  }
  .settings-section h2, .settings-section h3 {
    margin-top: 0;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border-color);
  }
  .add-form {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    align-items: center;
  }
  .add-form input { flex-grow: 1; margin-bottom: 0; }

  .item-list { list-style: none; padding: 0; }
  .item-list li {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 5px;
    border-bottom: 1px solid #eee;
  }
  .item-list li:last-child { border-bottom: none; }
  
  .item-actions { display: flex; gap: 10px; }
  .edit-form { display: none; gap: 10px; width: 100%; }
  .edit-form input { flex-grow: 1; margin-bottom: 0; }
  .edit-btn, .delete-btn {
    padding: 5px 10px;
    font-size: 0.9em;
    border: 1px solid var(--border-color);
    background-color: #fff;
    cursor: pointer;
  }
</style>
{% endblock %}

{% block content %}
<h1>הגדרות מערכת</h1>

<div class="settings-section">
    <h2>ניהול סוגי רישום</h2>
    <h3>הוסף סוג רישום חדש</h3>
    <form action="{{ url_for('add_contact_type') }}" method="post" class="add-form">
        <input type="text" name="name" placeholder="שם הסוג" required>
        <button type="submit" class="btn btn-primary">הוסף</button>
    </form>
    <h4>סוגים קיימים:</h4>
    <ul class="item-list">
        {% for c_type in contact_types %}
        <li>
            <span class="item-name">{{ c_type.name }}</span>
            <form class="edit-form" action="{{ url_for('edit_setting', item_type='contact_type', item_id=c_type.id) }}" method="post">
                <input type="text" name="name" value="{{ c_type.name }}" required>
                <button type="submit" class="btn btn-success">שמור</button>
            </form>
            <div class="item-actions">
                <button type="button" class="edit-btn">ערוך</button>
                <form action="{{ url_for('delete_setting', item_type='contact_type', item_id=c_type.id) }}" method="post" onsubmit="return confirm('האם אתה בטוח? פעולה זו תמחק גם את כל הסטטוסים המשויכים.');">
                    <button type="submit" class="delete-btn btn-danger" style="color:white;">מחק</button>
                </form>
            </div>
        </li>
        {% endfor %}
    </ul>
</div>

{% for c_type in contact_types %}
<div class="settings-section">
    <h3>ניהול סטטוסים עבור: {{ c_type.name }}</h3>
    <form action="{{ url_for('add_status') }}" method="post" class="add-form">
        <input type="hidden" name="contact_type_id" value="{{ c_type.id }}">
        <input type="text" name="name" placeholder="שם סטטוס חדש" required>
        <button type="submit" class="btn btn-primary">הוסף</button>
    </form>
    <ul class="item-list">
        {% for status in c_type.statuses %}
        <li>
            <span class="item-name">{{ status.name }}</span>
            <form class="edit-form" action="{{ url_for('edit_setting', item_type='status', item_id=status.id) }}" method="post">
                <input type="text" name="name" value="{{ status.name }}" required>
                <button type="submit" class="btn btn-success">שמור</button>
            </form>
            <div class="item-actions">
                <button type="button" class="edit-btn">ערוך</button>
                <form action="{{ url_for('delete_setting', item_type='status', item_id=status.id) }}" method="post" onsubmit="return confirm('האם אתה בטוח?')">
                    <button type="submit" class="delete-btn btn-danger" style="color:white;">מחק</button>
                </form>
            </div>
        </li>
        {% endfor %}
    </ul>
</div>
{% endfor %}

<div class="settings-section">
    <h2>ניהול סוגי התקשרות</h2>
    <form action="{{ url_for('add_activity_type') }}" method="post" class="add-form">
        <input type="text" name="name" placeholder="שם הסוג" required>
        <button type="submit" class="btn btn-primary">הוסף</button>
    </form>
    <ul class="item-list">
        {% for a_type in activity_types %}
        <li>
            <span class="item-name">{{ a_type.name }}</span>
            <form class="edit-form" action="{{ url_for('edit_setting', item_type='activity_type', item_id=a_type.id) }}" method="post">
                <input type="text" name="name" value="{{ a_type.name }}" required>
                <button type="submit" class="btn btn-success">שמור</button>
            </form>
            <div class="item-actions">
                <button type="button" class="edit-btn">ערוך</button>
                <form action="{{ url_for('delete_setting', item_type='activity_type', item_id=a_type.id) }}" method="post" onsubmit="return confirm('האם אתה בטוח?')">
                    <button type="submit" class="delete-btn btn-danger" style="color:white;">מחק</button>
                </form>
            </div>
        </li>
        {% endfor %}
    </ul>
</div>

<div class="settings-section" style="border: 2px solid #ffc107;">
    <h2>ניהול שדות מותאמים אישית</h2>
    <h3>הוסף שדה חדש לכרטיס הלקוח</h3>
    <form action="{{ url_for('add_custom_field') }}" method="post" class="add-form">
        <input type="text" name="name" placeholder="שם השדה (לדוגמה: טלפון נוסף)" required>
        <button type="submit" class="btn btn-primary">הוסף שדה</button>
    </form>
    <h4>שדות קיימים:</h4>
    <ul class="item-list">
        {% for field in custom_fields %}
        <li>
            <span class="item-name">{{ field.name }}</span>
            <form class="edit-form" action="{{ url_for('edit_custom_field', field_id=field.id) }}" method="post">
                <input type="text" name="name" value="{{ field.name }}" required>
                <button type="submit" class="btn btn-success">שמור</button>
            </form>
            <div class="item-actions">
                <button type="button" class="edit-btn">ערוך</button>
                <form action="{{ url_for('delete_custom_field', field_id=field.id) }}" method="post" onsubmit="return confirm('האם אתה בטוח? פעולה זו תמחק את השדה ואת כל הנתונים שהוזנו בו בכל כרטיסי הלקוח.');">
                    <button type="submit" class="delete-btn btn-danger" style="color:white;">מחק</button>
                </form>
            </div>
        </li>
        {% endfor %}
    </ul>
</div>

<script>
document.querySelectorAll('.edit-btn').forEach(button => {
    button.addEventListener('click', event => {
        const li = event.target.closest('li');
        li.querySelector('.item-name').style.display = 'none';
        li.querySelector('.item-actions').style.display = 'none';
        li.querySelector('.edit-form').style.display = 'flex';
    });
});
</script>
{% endblock %}
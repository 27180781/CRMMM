{% extends "base.html" %}

{% block head %}
{{ super() }}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  :root {
    --primary-color: #007bff; --primary-hover-color: #0056b3; --bg-color: #f8f9fa;
    --panel-bg-color: #ffffff; --text-color: #343a40; --text-light-color: #6c757d;
    --border-color: #dee2e6; --shadow: 0 4px 12px rgba(0, 0, 0, 0.1); --border-radius: 8px;
  }
  body { font-family: 'Heebo', sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; }
  .dashboard-container { padding: 25px; max-width: 1400px; margin: 0 auto; }
  .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;}
  .dashboard-header h1 { margin: 0; font-size: 2rem; font-weight: 700; }
  .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; font-weight: 500; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; gap: 8px; }
  .btn .icon { width: 16px; height: 16px; }
  .btn-primary { background-color: var(--primary-color); color: white; }
  .btn-primary:hover { background-color: var(--primary-hover-color); }
  
  /* --- תצוגות שמורות --- */
  .saved-views-bar { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; padding: 10px 0;}
  .saved-views-bar strong { font-weight: 500; }
  .saved-views-bar a { background-color: #e9ecef; color: var(--text-color); padding: 6px 14px; border-radius: 20px; font-size: 0.9em; text-decoration: none; transition: all 0.2s; }
  .saved-views-bar a:hover { background-color: #d3d9df; }
  .saved-views-bar a.active { background-color: var(--primary-color); color: #ffffff; font-weight: 500; }
  
  /* --- פאנל סינון נשלף --- */
  .filter-popup { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); z-index: 1000; }
  .filter-popup-content { position: absolute; top: 70px; left: 50px; background: var(--panel-bg-color); border-radius: var(--border-radius); box-shadow: var(--shadow); padding: 25px; width: 320px; }
  .popup-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
  .popup-header h3 { margin: 0; font-size: 1.25rem; }
  .close-btn { font-size: 1.5rem; cursor: pointer; border: none; background: none; color: var(--text-light-color); }
  .form-group { margin-bottom: 18px; }
  .form-group label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 0.9rem; }
  .form-group select { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; }
  
  /* --- טבלה --- */
  .table-container { background-color: var(--panel-bg-color); border-radius: var(--border-radius); box-shadow: var(--shadow); overflow: hidden; }
  .data-table { width: 100%; border-collapse: collapse; }
  .data-table th, .data-table td { padding: 14px 16px; text-align: right; border-bottom: 1px solid var(--border-color); }
  .data-table thead tr { background-color: #f8f9fa; }
  .data-table th { font-size: 0.85rem; font-weight: 700; color: var(--text-light-color); }
  .data-table tbody tr:hover { background-color: #f1f7ff; }
  .data-table a { color: var(--primary-color); font-weight: 500; text-decoration: none; }
  .data-table a:hover { text-decoration: underline; }
  .empty-row td { text-align: center; padding: 40px; color: var(--text-light-color); }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
  <div class="dashboard-header">
    <h1>דשבורד ראשי</h1>
    <button id="open-filter-popup" class="btn btn-primary">
      <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor"><path d="M3.853 54.87C10.47 40.9 24.54 32 40 32H472c15.46 0 29.53 8.901 36.15 22.87C514.8 66.7 512.2 81.96 501.9 92.28L320 274.3V448c0 12.1-6.852 23.22-17.75 28.59C291.4 481.9 278.4 482.2 267.5 476.5L139.5 412.5C129.5 407.4 128 396.6 128 384.4V274.3L10.12 92.28C-.2132 81.96-2.753 66.7 3.853 54.87z"/></svg>
      <span>סינון וניהול תצוגות</span>
    </button>
  </div>

  <div class="saved-views-bar">
    <strong>תצוגות מהירות:</strong>
    <a href="{{ url_for('index') }}" class="{% if not request.args.get('view_id') %}active{% endif %}">ברירת מחדל</a>
    {% for view in saved_views %}
      <a href="{{ url_for('index', view_id=view.id) }}" class="{% if request.args.get('view_id')|int == view.id %}active{% endif %}">{{ view.name }}</a>
    {% endfor %}
  </div>

  <div class="table-container">
    <table class="data-table">
        <thead>
            <tr>
              <th>שם</th>
              <th>סוג</th>
              <th>סטטוס</th>
              <th>תאריך יצירה</th>
              <th>תאריך עדכון אחרון</th>
            </tr>
          </thead>
          <tbody>
            {% for contact in contacts %}
            <tr>
              <td><a href="{{ url_for('contact_detail', contact_id=contact.id) }}">{{ contact.name }}</a></td>
              <td>{{ contact.contact_type.name if contact.contact_type else '' }}</td>
              <td>{{ contact.status.name if contact.status else '' }}</td>
              <td>{{ contact.created_at.strftime('%d-%m-%Y %H:%M') }}</td>
              <td>{{ contact.updated_at.strftime('%d-%m-%Y %H:%M') }}</td>
            </tr>
            {% else %}
            <tr class="empty-row">
              <td colspan="5">לא נמצאו תוצאות התואמות לסינון.</td>
            </tr>
            {% endfor %}
          </tbody>
    </table>
  </div>
</div>

<div id="filter-popup" class="filter-popup">
  <div class="filter-popup-content">
    <div class="popup-header">
      <h3>סינון מתקדם</h3>
      <button id="close-filter-popup" class="close-btn">&times;</button>
    </div>
    <form method="get" id="filter-form">
      <div class="form-group">
        <label for="contact_type_id">סוג רישום:</label>
        <select name="contact_type_id" id="contact_type_id">
          <option value="">הכל</option>
          {% for c_type in contact_types %}
            <option value="{{ c_type.id }}" {% if active_type_filter == c_type.id %}selected{% endif %}>{{ c_type.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group">
        <label for="status_id">סטטוסים:</label>
        <select name="status_id" id="status_id" multiple size="5"></select>
      </div>
      <div class="form-group">
        <label for="sort_by">סדר לפי:</label>
        <select name="sort_by" id="sort_by">
            <option value="created_at_desc" {% if active_sort == 'created_at_desc' %}selected{% endif %}>תאריך יצירה (חדש לישן)</option>
            <option value="created_at_asc" {% if active_sort == 'created_at_asc' %}selected{% endif %}>תאריך יצירה (ישן לחדש)</option>
            <option value="updated_at_desc" {% if active_sort == 'updated_at_desc' %}selected{% endif %}>עדכון אחרון (חדש לישן)</option>
            <option value="updated_at_asc" {% if active_sort == 'updated_at_asc' %}selected{% endif %}>עדכון אחרון (ישן לחדש)</option>
        </select>
      </div>
      <button type="submit" class="btn btn-primary" style="width:100%">החל סינון</button>
    </form>
    <hr style="margin: 20px 0;">
    <div>
        <h4>ניהול תצוגות</h4>
        <button type="button" id="save-view-btn" class="btn" style="width:100%; background-color: #28a745; color:white;">שמור תצוגה נוכחית</button>
        </div>
  </div>
</div>

<script>
  // --- לוגיקה לפתיחה וסגירה של פאנל הסינון ---
  const popup = document.getElementById('filter-popup');
  const openBtn = document.getElementById('open-filter-popup');
  const closeBtn = document.getElementById('close-filter-popup');

  openBtn.addEventListener('click', () => { popup.style.display = 'block'; });
  closeBtn.addEventListener('click', () => { popup.style.display = 'none'; });
  window.addEventListener('click', (event) => {
    if (event.target == popup) {
      popup.style.display = 'none';
    }
  });

  // --- לוגיקה קיימת לסינון דינמי ושמירת תצוגות ---
  const allStatuses = [
    {% for status in all_statuses %}
      { id: {{ status.id }}, name: '{{ status.name }}', type_id: {{ status.contact_type_id }} },
    {% endfor %}
  ];
  const activeStatusFilter = {{ active_status_filter|tojson }};
  const typeSelect = document.getElementById('contact_type_id');
  const statusSelect = document.getElementById('status_id');
  
  function updateStatusOptions() {
    const selectedTypeId = typeSelect.value;
    statusSelect.innerHTML = '';
    const statusesToShow = selectedTypeId ? allStatuses.filter(s => s.type_id.toString() === selectedTypeId) : allStatuses;
    statusesToShow.forEach(status => {
      const option = document.createElement('option');
      option.value = status.id;
      option.textContent = status.name;
      if (activeStatusFilter.includes(status.id)) {
        option.selected = true;
      }
      statusSelect.appendChild(option);
    });
  }
  
  typeSelect.addEventListener('change', updateStatusOptions);
  document.addEventListener('DOMContentLoaded', updateStatusOptions);

  document.getElementById('save-view-btn').addEventListener('click', function() {
    const viewName = prompt('אנא הכנס שם לתצוגה החדשה:');
    if (viewName) {
      const filters = {
        contact_type_id: document.getElementById('contact_type_id').value ? parseInt(document.getElementById('contact_type_id').value) : null,
        status_id: Array.from(document.getElementById('status_id').selectedOptions).map(opt => parseInt(opt.value)),
        sort_by: document.getElementById('sort_by').value
      };

      fetch('/api/save_view', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: viewName, filters: filters }),
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert(data.message);
          window.location.href = window.location.pathname; // חזור לדף הבית הנקי
        } else {
          alert('שגיאה בשמירת התצוגה.');
        }
      });
    }
  });
</script>
{% endblock %}